<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seaside Beacon â€” Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#09090b;--surface:#111113;--surface2:#18181b;--surface3:#1f1f23;
  --border:#27272a;--border-light:#3f3f46;
  --t1:#fafafa;--t2:#a1a1aa;--t3:#71717a;--t4:#52525b;
  --green:#22c55e;--green-bg:rgba(34,197,94,0.1);
  --red:#ef4444;--red-bg:rgba(239,68,68,0.1);
  --amber:#f59e0b;--amber-bg:rgba(245,158,11,0.1);
  --blue:#3b82f6;--blue-bg:rgba(59,130,246,0.1);
  --violet:#8b5cf6;--violet-bg:rgba(139,92,246,0.1);
  --cyan:#06b6d4;
  --accent:#f97316;
  --sans:'Inter',system-ui,sans-serif;
  --mono:'JetBrains Mono','SF Mono',monospace;
  --radius:8px;--radius-lg:12px;
}
html{font-size:13px}
body{font-family:var(--sans);background:var(--bg);color:var(--t1);min-height:100vh;-webkit-font-smoothing:antialiased}

/* â”€â”€ Login â”€â”€ */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:48px 40px;width:360px;text-align:center}
.login-card h1{font-size:15px;font-weight:600;letter-spacing:-.2px;margin-bottom:2px}
.login-card .sub{font-size:12px;color:var(--t3);margin-bottom:32px}
.login-card input{display:block;width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);font-size:12px;font-family:var(--sans);outline:none;margin-bottom:10px;transition:.15s}
.login-card input:focus{border-color:var(--t3)}
.login-card input::placeholder{color:var(--t4)}
.login-card button{width:100%;padding:9px;background:var(--t1);border:none;border-radius:6px;color:var(--bg);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;font-family:var(--sans)}
.login-card button:hover{opacity:.9}
.login-error{color:var(--red);font-size:11px;margin-top:10px;display:none}

/* â”€â”€ Dashboard â”€â”€ */
#dashboard{display:none;padding:24px 32px;max-width:1380px;margin:0 auto}
@media(max-width:768px){#dashboard{padding:16px}}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.header-left{display:flex;align-items:center;gap:12px}
.header-left h1{font-size:16px;font-weight:600;letter-spacing:-.3px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.header-right{display:flex;align-items:center;gap:14px;font-size:11px;color:var(--t3)}
.header-right .tag{padding:3px 8px;border-radius:4px;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.6px}
.tag-live{background:var(--green-bg);color:var(--green)}
.sign-out{background:none;border:1px solid var(--border);border-radius:5px;padding:5px 12px;color:var(--t3);font-size:11px;cursor:pointer;font-family:var(--sans);transition:.15s}
.sign-out:hover{color:var(--t1);border-color:var(--t3)}

/* Grid */
.row{display:grid;gap:14px;margin-bottom:14px}
.cols-4{grid-template-columns:repeat(4,1fr)}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:1fr 1fr}
.cols-5-7{grid-template-columns:5fr 7fr}
.cols-7-5{grid-template-columns:7fr 5fr}
@media(max-width:900px){.cols-4,.cols-3,.cols-5-7,.cols-7-5{grid-template-columns:1fr}}
@media(max-width:600px){.cols-2{grid-template-columns:1fr}}

/* Card */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px 20px}
.card-title{font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:.7px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
.card-title .badge{font-size:10px;padding:2px 6px;border-radius:3px;text-transform:none;letter-spacing:0;font-weight:500}

/* Stat */
.stat-val{font-size:26px;font-weight:700;font-family:var(--mono);letter-spacing:-1px;line-height:1}
.stat-label{font-size:11px;color:var(--t4);margin-top:3px}
.stat-row{display:flex;align-items:baseline;gap:8px}
.stat-change{font-size:11px;font-weight:600}

/* Status dot */
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-green{background:var(--green)}.dot-red{background:var(--red)}.dot-amber{background:var(--amber)}

/* Table */
.tbl{width:100%;border-collapse:collapse;font-size:12px}
.tbl th{text-align:left;padding:7px 10px;color:var(--t4);font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.tbl td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--t2)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--surface2)}
.mono{font-family:var(--mono)}

/* Score badge */
.sb{display:inline-block;padding:2px 7px;border-radius:4px;font-size:11px;font-weight:600;font-family:var(--mono)}
.sb-go{background:var(--green-bg);color:var(--green)}
.sb-maybe{background:var(--amber-bg);color:var(--amber)}
.sb-skip{background:var(--blue-bg);color:var(--blue)}
.sb-no{background:var(--red-bg);color:var(--red)}

/* Service row */
.svc{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)}
.svc:last-child{border-bottom:none}
.svc-name{font-size:12px;color:var(--t2);display:flex;align-items:center;gap:7px}
.svc-val{font-family:var(--mono);font-size:12px;color:var(--t1)}
.svc-sub{font-size:11px;color:var(--cyan);margin-left:8px}

/* Chart */
.chart{height:120px;display:flex;align-items:flex-end;gap:2px;padding-top:8px}
.bar{flex:1;border-radius:2px 2px 0 0;min-height:1px;transition:.3s;position:relative;cursor:crosshair}
.bar:hover{opacity:.75}
.bar .tip{display:none;position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--surface3);border:1px solid var(--border);color:var(--t1);font-size:10px;padding:4px 8px;border-radius:4px;white-space:nowrap;font-family:var(--mono);z-index:5;pointer-events:none}
.bar:hover .tip{display:block}
.chart-x{display:flex;justify-content:space-between;padding-top:5px;font-size:9px;color:var(--t4);font-family:var(--mono)}

/* Progress */
.prog{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden;margin-top:8px}
.prog-fill{height:100%;border-radius:2px;transition:.5s}

/* Scroll */
.scroll-y{max-height:260px;overflow-y:auto}
.scroll-y::-webkit-scrollbar{width:3px}
.scroll-y::-webkit-scrollbar-thumb{background:var(--t4);border-radius:2px}

/* Error log */
.err-entry{padding:5px 0;border-bottom:1px solid var(--border);display:flex;gap:6px;font-family:var(--mono);font-size:11px}
.err-time{color:var(--t4);white-space:nowrap;flex-shrink:0}
.err-svc{color:var(--amber);flex-shrink:0}
.err-msg{color:var(--t2);word-break:break-all}
.empty-state{color:var(--t4);text-align:center;padding:20px 0;font-size:12px}

/* Prediction cards â€” detailed 2-column layout */
.pred-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;position:relative}
.pred-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
.pred-beach{font-size:14px;font-weight:600;color:var(--t1)}
.pred-beach-sub{font-size:10px;color:var(--t4);margin-top:2px}
.pred-score-block{text-align:right}
.pred-score{font-size:42px;font-weight:700;font-family:var(--mono);line-height:1;letter-spacing:-2px}
.pred-verdict{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.pred-rec{display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;letter-spacing:.5px;margin-top:4px}

/* Section headers */
.pred-section{font-size:10px;font-weight:600;color:var(--t4);text-transform:uppercase;letter-spacing:.7px;margin:14px 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}

/* Scoring breakdown table */
.pred-scores{width:100%;font-size:11px;border-collapse:collapse}
.pred-scores td{padding:4px 0;vertical-align:middle}
.pred-scores td:first-child{color:var(--t3);width:40%}
.pred-scores td:nth-child(2){font-family:var(--mono);color:var(--t1);font-weight:500;width:25%;text-align:right}
.pred-scores td:nth-child(3){width:35%;padding-left:8px}
.pred-bar-track{height:4px;background:var(--surface3);border-radius:2px;overflow:hidden}
.pred-bar-fill{height:100%;border-radius:2px;transition:.3s}

/* Conditions grid */
.pred-conds{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;font-size:11px}
.pred-cond-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
.pred-cond-item .lbl{color:var(--t3)}
.pred-cond-item .val{font-family:var(--mono);color:var(--t1);font-weight:500}
.pred-cond-item .tag{font-size:9px;padding:1px 5px;border-radius:3px;font-weight:500;margin-left:6px}

/* Cloud layers */
.cloud-layers{display:flex;gap:6px;margin-top:6px}
.cloud-layer{flex:1;text-align:center;padding:6px 4px;background:var(--surface3);border-radius:6px}
.cloud-layer .cl-pct{font-family:var(--mono);font-size:16px;font-weight:600;color:var(--t1);line-height:1}
.cloud-layer .cl-name{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

/* Sun times */
.sun-row{display:flex;gap:12px;font-size:11px;color:var(--t3)}
.sun-row span{display:flex;align-items:center;gap:4px}
.sun-row .sun-val{font-family:var(--mono);color:var(--t1);font-weight:500}

/* AI insight */
.pred-insight{font-size:11px;color:var(--t2);line-height:1.6;margin-top:6px}
.pred-insight-worth{font-size:11px;color:var(--cyan);font-style:italic;margin-top:4px}

/* Data sources */
.pred-sources{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.pred-src{font-size:9px;padding:2px 6px;border-radius:3px;background:var(--surface3);color:var(--t4)}

@media(max-width:900px){#predGrid{grid-template-columns:1fr}}

/* Sub pill */
.beach-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:11px;background:var(--surface2);margin:3px 2px}
.beach-pill .ct{font-family:var(--mono);font-weight:600;color:var(--t1)}

/* Email broadcast */
.email-btn{padding:6px 14px;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--t2);font-size:11px;font-family:var(--sans);cursor:pointer;transition:.15s}
.email-btn:hover{border-color:var(--t3);color:var(--t1)}
.email-btn-active{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}
.email-send-btn{padding:9px 24px;border:none;border-radius:6px;background:var(--accent);color:white;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--sans);transition:.15s}
.email-send-btn:hover{opacity:.9}
.email-send-btn:disabled{opacity:.4;cursor:not-allowed}
.email-send-btn.sending{background:var(--t3)}
.rcpt-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px}
.rcpt-row label{display:flex;align-items:center;gap:6px;cursor:pointer;color:var(--t2);flex:1}
.rcpt-row input[type=checkbox]{accent-color:var(--blue);cursor:pointer}
.rcpt-beach{font-size:10px;color:var(--t3)}

/* Drop zone */
.drop-zone{border:1px dashed var(--border);border-radius:6px;padding:16px;text-align:center;transition:.15s;cursor:pointer}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--blue);background:var(--blue-bg)}
.att-item{display:flex;align-items:center;gap:8px;padding:5px 8px;background:var(--surface2);border-radius:5px;font-size:11px;margin:3px 0}
.att-item .att-name{flex:1;color:var(--t2);font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.att-item .att-size{color:var(--t4);font-family:var(--mono);font-size:10px}
.att-item .att-preview{width:28px;height:28px;border-radius:3px;object-fit:cover;flex-shrink:0}
.att-remove{background:none;border:none;color:var(--t4);cursor:pointer;font-size:14px;padding:0 4px;line-height:1}
.att-remove:hover{color:var(--red)}

/* AI source tag */
.pred-ai-src{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:500;text-transform:none;letter-spacing:0;vertical-align:middle;margin-left:6px}
.src-ai{background:var(--violet-bg);color:var(--violet)}
.src-rules{background:var(--surface3);color:var(--t3)}

/* Refresh bar */
.refresh-line{position:fixed;top:0;left:0;height:2px;background:var(--accent);z-index:100;transition:width .3s;opacity:0;pointer-events:none}

/* â”€â”€ Mobile responsive â”€â”€ */
@media(max-width:768px){
  .header{flex-direction:column;gap:12px;align-items:flex-start}
  .header-right{flex-wrap:wrap;gap:8px}
  .stat-val{font-size:20px}
  .card{padding:14px 16px}
  .card-title{font-size:10px}

  /* Prediction grid â†’ single column */
  #predGrid{grid-template-columns:1fr !important}

  /* Prediction card internals */
  .pred-score{font-size:32px}
  .pred-beach{font-size:13px}
  .pred-scores td:first-child{width:35%}
  .pred-scores td:nth-child(2){width:30%}
  .pred-scores td:nth-child(3){width:35%}

  /* Conditions grid â†’ single column on small phones */
  .pred-conds{grid-template-columns:1fr;gap:4px}

  /* Sun times â†’ wrap */
  .sun-row{flex-wrap:wrap;gap:6px 12px}

  /* Cloud layers â†’ tighter */
  .cloud-layers{gap:4px}
  .cloud-layer .cl-pct{font-size:14px}

  /* AI insight text wrap */
  .pred-insight{font-size:11px;word-break:break-word}

  /* Subscriber table scroll */
  .tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}

  /* Email section */
  .email-btn{padding:5px 10px;font-size:10px}

  /* Data sources wrap */
  .pred-sources{gap:3px}
  .pred-src{font-size:8px;padding:2px 5px}
}

@media(max-width:480px){
  #dashboard{padding:12px 10px}
  .header-left h1{font-size:14px}
  .stat-val{font-size:18px}
  .pred-header{flex-direction:column;gap:8px}
  .pred-score-block{text-align:left;display:flex;align-items:baseline;gap:8px}
  .pred-score{font-size:28px}
  .pred-verdict{font-size:10px;margin-top:0}
  .pred-scores{font-size:10px}
  .pred-section{font-size:9px;margin:10px 0 6px}
  .sun-row{font-size:10px}
  .pred-cond-item{font-size:10px}
}
</style>
</head>
<body>

<div class="refresh-line" id="refreshBar"></div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <h1>Seaside Beacon</h1>
    <p class="sub">Command Center</p>
    <input type="text" id="loginUser" placeholder="Username" autocomplete="username">
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn">Sign In</button>
    <div class="login-error" id="loginError">Invalid credentials</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

  <div class="header">
    <div class="header-left"><div class="live-dot"></div><h1>Command Center</h1></div>
    <div class="header-right">
      <span class="tag tag-live">Live</span>
      <span id="lastUpdate">â€”</span>
      <span id="uptime">â€”</span>
      <button class="sign-out" id="logoutBtn">Sign Out</button>
    </div>
  </div>

  <!-- ROW 1: Headline numbers (LIFETIME) -->
  <div class="row cols-4">
    <div class="card">
      <div class="card-title">Total Visitors <span class="badge" style="background:var(--blue-bg);color:var(--blue)" id="todayVisitsBadge">â€”</span></div>
      <div class="stat-val" id="lifetimeVisits">â€”</div>
      <div class="stat-label" id="lifetimeUnique">â€” unique</div>
    </div>
    <div class="card">
      <div class="card-title">Total Predictions <span class="badge" style="background:var(--green-bg);color:var(--green)" id="todayPredBadge">â€”</span></div>
      <div class="stat-val" id="lifetimePredictions">â€”</div>
      <div class="stat-label" id="lifetimeDays">â€” days tracked</div>
    </div>
    <div class="card">
      <div class="card-title">Active Subscribers <span class="badge" style="background:var(--violet-bg);color:var(--violet)" id="subCapBadge">â€”</span></div>
      <div class="stat-val" id="totalSubs">â€”</div>
      <div class="prog"><div class="prog-fill" id="subBar" style="width:0%;background:var(--violet)"></div></div>
      <div class="stat-label" style="margin-top:4px" id="subCapLabel">â€” / 300 Brevo limit</div>
    </div>
    <div class="card">
      <div class="card-title">Emails Delivered</div>
      <div class="stat-val" id="lifetimeEmails">â€”</div>
      <div class="stat-label" id="lifetimeForecasts">â€” forecasts generated</div>
    </div>
  </div>

  <!-- ROW 1.5: Live Predictions (24/7) -->
  <div class="row" style="grid-template-columns:1fr">
    <div class="card">
      <div class="card-title">Live Predictions <span class="badge" style="background:var(--green-bg);color:var(--green);cursor:pointer" id="predRefreshBtn">â†» Refresh</span></div>
      <div id="predGrid" style="display:grid;gap:16px;grid-template-columns:repeat(2,1fr)">
        <div class="empty-state" id="predLoading">Click Refresh to load predictions</div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:10px;color:var(--t4)">
        <span id="predFetchTime">â€”</span>
        <span id="predAutoLabel">Auto-refresh: 5 min</span>
      </div>
    </div>
  </div>

  <!-- ROW 2: Traffic chart + API status -->
  <div class="row cols-7-5">
    <div class="card">
      <div class="card-title">Traffic â€” Last 30 Days</div>
      <div class="chart" id="chart"></div>
      <div class="chart-x" id="chartX"></div>
    </div>
    <div class="card">
      <div class="card-title">Services</div>
      <div id="services">
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-awh"></span>AccuWeather Hourly</span><span class="svc-val" id="v-awh">â€”</span><span class="svc-sub" id="c-awh">â€”</span></div>
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-awd"></span>AccuWeather Daily</span><span class="svc-val" id="v-awd">â€”</span><span class="svc-sub" id="c-awd">â€”</span></div>
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-omf"></span>Open-Meteo Forecast</span><span class="svc-val" id="v-omf">â€”</span><span class="svc-sub" id="c-omf">â€”</span></div>
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-oma"></span>Open-Meteo AQ</span><span class="svc-val" id="v-oma">â€”</span><span class="svc-sub" id="c-oma">â€”</span></div>
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-ai"></span>AI Provider</span><span class="svc-val" id="v-ai">â€”</span><span class="svc-sub" id="c-ai">â€”</span></div>
        <div class="svc"><span class="svc-name"><span class="dot dot-green" id="d-db"></span>MongoDB</span><span class="svc-val" id="v-db">â€”</span></div>
      </div>
    </div>
  </div>

  <!-- ROW 3: Subscribers + Performance -->
  <div class="row cols-7-5">
    <div class="card">
      <div class="card-title">Subscribers <span class="badge" style="background:var(--surface2);color:var(--t2)" id="subCountBadge">â€”</span></div>
      <div style="margin-bottom:12px" id="beachPills"></div>
      <div class="scroll-y">
        <table class="tbl" id="subTable">
          <thead><tr><th>#</th><th>Email</th><th>Beach</th><th>Joined</th><th>Last Email</th></tr></thead>
          <tbody id="subBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Performance <span class="badge" style="background:var(--surface2);color:var(--t2)">This Session</span></div>
      <div class="row cols-2" style="gap:10px;margin-bottom:12px">
        <div><div style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Avg Response</div><div class="stat-val" style="font-size:22px" id="avgMs">â€”<span style="font-size:11px;color:var(--t4);font-weight:400">ms</span></div></div>
        <div><div style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">P95 Response</div><div class="stat-val" style="font-size:22px" id="p95Ms">â€”<span style="font-size:11px;color:var(--t4);font-weight:400">ms</span></div></div>
        <div><div style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Memory RSS</div><div class="stat-val" style="font-size:22px" id="memRss">â€”<span style="font-size:11px;color:var(--t4);font-weight:400">MB</span></div></div>
        <div><div style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Heap</div><div class="stat-val" style="font-size:22px" id="heapVal">â€”<span style="font-size:11px;color:var(--t4);font-weight:400">MB</span></div></div>
      </div>
      <div class="card-title" style="margin-top:8px">Cache Hit Rates</div>
      <div class="svc"><span class="svc-name">Prediction (10min)</span><span class="svc-val" id="cr-pred">â€”</span></div>
      <div class="svc"><span class="svc-name">AW Hourly (30min)</span><span class="svc-val" id="cr-awh">â€”</span></div>
      <div class="svc"><span class="svc-name">AW Daily (2h)</span><span class="svc-val" id="cr-awd">â€”</span></div>
      <div class="svc"><span class="svc-name">OM Forecast (6h)</span><span class="svc-val" id="cr-omf">â€”</span></div>
      <div class="svc"><span class="svc-name">OM AQ (6h)</span><span class="svc-val" id="cr-oma">â€”</span></div>
    </div>
  </div>

  <!-- ROW 3.5: Email Broadcast -->
  <div class="row" style="grid-template-columns:1fr">
    <div class="card" id="emailCard">
      <div class="card-title">Broadcast Email <span class="badge" style="background:var(--surface2);color:var(--t2)" id="emailStatus"></span></div>

      <!-- Recipient selection -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
        <button class="email-btn email-btn-active" id="selAll">All Subscribers</button>
        <button class="email-btn" id="selCustom">Select Recipients</button>
        <span style="font-size:11px;color:var(--t3)" id="recipientCount">0 recipients</span>
      </div>

      <!-- Custom recipient list (hidden by default) -->
      <div id="recipientPicker" style="display:none;margin-bottom:12px;max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:8px">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
          <input type="text" id="recipientSearch" placeholder="Search emails..." style="flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--t1);font-size:11px;font-family:var(--sans);outline:none">
          <button class="email-btn" id="selNone" style="font-size:10px;padding:4px 8px">Deselect All</button>
        </div>
        <div id="recipientList"></div>
      </div>

      <!-- Sender -->
      <div style="margin-bottom:10px">
        <label style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">From</label>
        <select id="emailFrom" style="width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);font-size:12px;font-family:var(--mono);outline:none;cursor:pointer;-webkit-appearance:none">
          <option value="hello@seasidebeacon.com">hello@seasidebeacon.com</option>
          <option value="forecast@seasidebeacon.com">forecast@seasidebeacon.com</option>
        </select>
      </div>

      <!-- Subject -->
      <div style="margin-bottom:10px">
        <label style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Subject</label>
        <input type="text" id="emailSubject" placeholder="e.g. Exciting update from Seaside Beacon" style="width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);font-size:12px;font-family:var(--sans);outline:none;box-sizing:border-box">
      </div>

      <!-- Body -->
      <div style="margin-bottom:12px">
        <label style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Body <span style="color:var(--t4);text-transform:none;letter-spacing:0">(plain text â€” auto-wrapped in Seaside Beacon template)</span></label>
        <textarea id="emailBody" rows="6" placeholder="Write your message here..." style="width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);font-size:12px;font-family:var(--sans);outline:none;resize:vertical;line-height:1.6;box-sizing:border-box"></textarea>
      </div>

      <!-- Attachments -->
      <div style="margin-bottom:12px">
        <label style="font-size:10px;color:var(--t4);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Attachments <span style="color:var(--t4);text-transform:none;letter-spacing:0">(images, PDFs â€” max 20MB total)</span></label>
        <div id="dropZone" class="drop-zone">
          <input type="file" id="fileInput" multiple accept="image/*,.pdf,.jpg,.jpeg,.png,.webp" style="display:none">
          <span style="color:var(--t3);font-size:12px">Drop files here or <span style="color:var(--blue);cursor:pointer;text-decoration:underline" id="fileBrowse">browse</span></span>
        </div>
        <div id="attachmentList" style="margin-top:6px"></div>
      </div>

      <!-- Send button -->
      <div style="display:flex;align-items:center;gap:12px">
        <button class="email-send-btn" id="emailSendBtn">Send Broadcast</button>
        <div id="emailResult" style="font-size:12px;color:var(--t3)"></div>
      </div>
    </div>
  </div>

  <!-- ROW 4: Scores + Errors -->
  <div class="row cols-7-5">
    <div class="card">
      <div class="card-title">Forecast History</div>
      <div class="scroll-y">
        <table class="tbl">
          <thead><tr><th>Date</th><th>Marina</th><th>Elliot's</th><th>Covelong</th><th>Thiruvanmiyur</th><th>Avg</th><th>Best</th></tr></thead>
          <tbody id="scoreBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Error Log <span class="badge" style="background:var(--red-bg);color:var(--red)" id="errBadge">0</span></div>
      <div class="scroll-y" id="errLog"><div class="empty-state">No errors this session</div></div>
    </div>
  </div>

</div>

<script>
const API = window.location.origin;
let token = localStorage.getItem('sb_token');
let interval;

// â”€â”€ Auth â”€â”€
function login() {
  const u = document.getElementById('loginUser').value;
  const p = document.getElementById('loginPass').value;
  const e = document.getElementById('loginError');
  fetch(API + '/api/admin/login', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({username:u, password:p})
  }).then(r=>r.json()).then(d=>{
    if(d.success){token=d.token;localStorage.setItem('sb_token',token);show();}
    else{e.style.display='block';e.textContent=d.error||'Invalid credentials';}
  }).catch(()=>{e.style.display='block';e.textContent='Connection failed';});
}
function logout(){token=null;localStorage.removeItem('sb_token');clearInterval(interval);document.getElementById('dashboard').style.display='none';document.getElementById('loginScreen').style.display='flex';}
function show(){document.getElementById('loginScreen').style.display='none';document.getElementById('dashboard').style.display='block';poll();interval=setInterval(poll,6000);startPredAutoRefresh();}

// â”€â”€ Poll â”€â”€
function poll(){
  const bar=document.getElementById('refreshBar');bar.style.opacity='1';bar.style.width='50%';
  fetch(API+'/api/admin/metrics',{headers:{'X-Admin-Token':token}})
    .then(r=>{if(r.status===401){logout();throw'auth';}return r.json();})
    .then(d=>{bar.style.width='100%';setTimeout(()=>{bar.style.opacity='0';bar.style.width='0'},200);render(d);})
    .catch(e=>{if(e!=='auth'){bar.style.background='var(--red)';bar.style.width='100%';setTimeout(()=>{bar.style.opacity='0';bar.style.width='0';bar.style.background='var(--accent)'},800);}});
}

// â”€â”€ Render â”€â”€
function render(d){
  const t=d.traffic, s=d.subscribers, ss=d.siteStats, se=d.session, db=d.database;
  const now=new Date();
  $('lastUpdate','Updated '+now.toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false})+' IST');
  $('uptime', se?.server?.uptimeFormatted||'â€”');

  // Headline â€” LIFETIME numbers
  $('lifetimeVisits', fmt(t.lifetime.visits));
  $('lifetimeUnique', fmt(t.lifetime.unique)+' unique');
  $('todayVisitsBadge', (t.today.visits||0)+' today');
  $('lifetimePredictions', fmt(t.lifetime.predictions));
  $('todayPredBadge', (t.today.predictions||0)+' today');
  $('lifetimeDays', t.totalDays+' days tracked');

  $('totalSubs', s.total);
  const pct=Math.min(100,Math.round(s.total/300*100));
  document.getElementById('subBar').style.width=pct+'%';
  document.getElementById('subBar').style.background=pct>80?'var(--red)':pct>50?'var(--amber)':'var(--violet)';
  $('subCapBadge', pct+'%');
  $('subCapLabel', s.total+' / 300 Brevo limit');

  $('lifetimeEmails', fmt(ss?.emailsSent||0));
  $('lifetimeForecasts', fmt(ss?.forecastsGenerated||0)+' forecasts');

  // Services
  svc('awh',se.apis?.accuWeatherHourly,se.cache?.accuWeatherHourlyCacheRate);
  svc('awd',se.apis?.accuWeatherDaily,se.cache?.accuWeatherDailyCacheRate);
  svc('omf',se.apis?.openMeteoForecast,se.cache?.openMeteoForecastCacheRate);
  svc('oma',se.apis?.openMeteoAQ,se.cache?.openMeteoAQCacheRate);
  const g=se.apis?.aiProvider||{};
  const provStr=Object.entries(g.providers||{}).map(([k,v])=>k+':'+v).join(' | ')||'none';
  dot('d-ai',g.errors>0?'amber':'green');$('v-ai',(g.calls||0)+' calls');$('c-ai',provStr+' | '+(g.fallbacks||0)+' fallbacks');
  dot('d-db',db?.connected?'green':'red');$('v-db',db?.connected?'Connected':'Down');

  // Performance
  $('avgMs',(se.performance?.avgResponseTime||0));$('p95Ms',(se.performance?.p95ResponseTime||0));
  $('memRss',(se.server?.memory?.rss||0));$('heapVal',(se.server?.memory?.heapUsed||0));

  // Cache rates
  $('cr-pred',se.cache?.predictionCacheRate||'0%');
  $('cr-awh',se.cache?.accuWeatherHourlyCacheRate||'0%');
  $('cr-awd',se.cache?.accuWeatherDailyCacheRate||'0%');
  $('cr-omf',se.cache?.openMeteoForecastCacheRate||'0%');
  $('cr-oma',se.cache?.openMeteoAQCacheRate||'0%');

  // Chart
  chart(t.last30||[]);

  // Subscribers
  subTable(s);

  // Feed subscriber list to email module
  if (s.list && s.list.length) {
    allSubEmails = s.list.map(sub => ({ email: sub.email, preferredBeach: sub.preferredBeach }));
    if (emailMode === 'all') updateRecipientCount();
  }

  // Scores
  scoreTable(d.scores||[]);

  // Errors
  errLog(se.recentErrors||[]);
}

function svc(key,api,cacheRate){
  const a=api||{};
  dot('d-'+key, a.errors>0?'amber':'green');
  $('v-'+key, (a.calls||0)+' calls');
  $('c-'+key, cacheRate||'0%');
}

function chart(days){
  const el=document.getElementById('chart');
  const xEl=document.getElementById('chartX');
  if(!days.length){el.innerHTML='<div class="empty-state">No data</div>';xEl.innerHTML='';return;}
  const max=Math.max(...days.map(d=>d.visits||0),1);
  el.innerHTML=days.map(d=>{
    const h=Math.max(1,((d.visits||0)/max)*110);
    const dt=new Date(d.date+'T00:00:00+05:30');
    const lbl=dt.toLocaleDateString('en-IN',{day:'numeric',month:'short'});
    return '<div class="bar" style="height:'+h+'px;background:var(--blue)"><div class="tip">'+lbl+': '+fmt(d.visits||0)+' visits, '+(d.predictions||0)+' pred</div></div>';
  }).join('');
  // show first, mid, last labels
  if(days.length>=3){
    const f=new Date(days[0].date+'T00:00:00+05:30').toLocaleDateString('en-IN',{day:'numeric',month:'short'});
    const l=new Date(days[days.length-1].date+'T00:00:00+05:30').toLocaleDateString('en-IN',{day:'numeric',month:'short'});
    xEl.innerHTML='<span>'+f+'</span><span>'+l+'</span>';
  }
}

function subTable(s){
  const beaches={marina:'Marina',elliot:"Elliot's",covelong:'Covelong',thiruvanmiyur:'Thiruvanmiyur'};
  const colors={marina:'var(--blue)',elliot:'var(--violet)',covelong:'var(--green)',thiruvanmiyur:'var(--amber)'};
  // Pills
  document.getElementById('beachPills').innerHTML=Object.entries(beaches).map(([k,v])=>{
    return '<span class="beach-pill"><span style="width:6px;height:6px;border-radius:2px;background:'+colors[k]+';display:inline-block"></span>'+v+' <span class="ct">'+(s.byBeach[k]||0)+'</span></span>';
  }).join('');
  $('subCountBadge', s.total+' total');

  // Table
  const body=document.getElementById('subBody');
  if(!s.list||!s.list.length){body.innerHTML='<tr><td colspan="5" class="empty-state">No subscribers</td></tr>';return;}
  body.innerHTML=s.list.map((sub,i)=>{
    const joined=new Date(sub.subscribedAt).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
    const lastMail=sub.lastEmailSent?timeAgo(new Date(sub.lastEmailSent)):'Never';
    const bName=beaches[sub.preferredBeach]||sub.preferredBeach;
    const bColor=colors[sub.preferredBeach]||'var(--t3)';
    return '<tr><td class="mono" style="color:var(--t4)">'+(i+1)+'</td><td class="mono" style="color:var(--t1)">'+esc(sub.email)+'</td><td><span style="color:'+bColor+'">'+bName+'</span></td><td style="color:var(--t3)">'+joined+'</td><td style="color:var(--t3)">'+lastMail+'</td></tr>';
  }).join('');
}

function scoreTable(scores){
  const body=document.getElementById('scoreBody');
  if(!scores.length){body.innerHTML='<tr><td colspan="7" class="empty-state">No scores yet</td></tr>';return;}
  body.innerHTML=scores.map(s=>{
    const bs={};(s.beaches||[]).forEach(b=>{bs[b.beachKey]=b;});
    const best=s.bestBeach?.beachKey||'';
    return '<tr><td class="mono">'+s.date+'</td>'+
      ['marina','elliot','covelong','thiruvanmiyur'].map(k=>{
        const b=bs[k];if(!b)return'<td>â€”</td>';
        const cls=b.recommendation==='GO'?'sb-go':b.recommendation==='MAYBE'?'sb-maybe':b.recommendation==='SKIP'?'sb-skip':'sb-no';
        return '<td><span class="sb '+cls+'">'+b.score+'</span></td>';
      }).join('')+
      '<td class="mono">'+(s.averageScore?Math.round(s.averageScore):'â€”')+'</td>'+
      '<td style="color:var(--green);font-size:11px">'+(best?cap(best):'â€”')+'</td></tr>';
  }).join('');
}

function errLog(errors){
  const el=document.getElementById('errLog');
  $('errBadge', errors.length);
  if(!errors.length){el.innerHTML='<div class="empty-state">No errors this session</div>';return;}
  el.innerHTML=[...errors].reverse().map(e=>{
    const t=new Date(e.timestamp);
    return '<div class="err-entry"><span class="err-time">'+t.toLocaleTimeString('en-IN',{hour12:false})+'</span><span class="err-svc">'+e.service+'</span><span class="err-msg">'+esc(e.message)+'</span></div>';
  }).join('');
}

// â”€â”€ Helpers â”€â”€
function $(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function dot(id,c){const e=document.getElementById(id);if(e)e.className='dot dot-'+c;}
function fmt(n){return Number(n).toLocaleString();}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

// â”€â”€ Email Broadcast â”€â”€
let emailMode = 'all'; // 'all' or 'custom'
let allSubEmails = []; // populated from poll data
let selectedEmails = new Set();

function updateRecipientCount() {
  const count = emailMode === 'all' ? allSubEmails.length : selectedEmails.size;
  $('recipientCount', count + ' recipient' + (count !== 1 ? 's' : ''));
}

function buildRecipientList(filter) {
  const beaches = {marina:'Marina',elliot:"Elliot's",covelong:'Covelong',thiruvanmiyur:'Thiruvanmiyur'};
  const list = document.getElementById('recipientList');
  const filtered = filter ? allSubEmails.filter(s => s.email.toLowerCase().includes(filter.toLowerCase())) : allSubEmails;
  list.innerHTML = filtered.map(s => {
    const checked = selectedEmails.has(s.email) ? 'checked' : '';
    return '<div class="rcpt-row"><label><input type="checkbox" value="'+esc(s.email)+'" '+checked+'> <span class="mono">'+esc(s.email)+'</span></label><span class="rcpt-beach">'+(beaches[s.preferredBeach]||s.preferredBeach)+'</span></div>';
  }).join('');
  // Bind checkbox changes
  list.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', function() {
      if (this.checked) selectedEmails.add(this.value);
      else selectedEmails.delete(this.value);
      updateRecipientCount();
    });
  });
}

function setEmailMode(mode) {
  emailMode = mode;
  document.getElementById('selAll').className = 'email-btn' + (mode === 'all' ? ' email-btn-active' : '');
  document.getElementById('selCustom').className = 'email-btn' + (mode === 'custom' ? ' email-btn-active' : '');
  document.getElementById('recipientPicker').style.display = mode === 'custom' ? 'block' : 'none';
  if (mode === 'all') {
    selectedEmails = new Set(allSubEmails.map(s => s.email));
  }
  updateRecipientCount();
}

// â”€â”€ Attachments â”€â”€
let attachments = []; // { name, size, base64, type, previewUrl }

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function addFiles(files) {
  const maxTotal = 20 * 1024 * 1024; // 20MB
  for (const file of files) {
    const currentTotal = attachments.reduce((sum, a) => sum + a.size, 0);
    if (currentTotal + file.size > maxTotal) {
      alert('Total attachment size would exceed 20MB. Skipping: ' + file.name);
      continue;
    }
    if (attachments.some(a => a.name === file.name)) continue; // skip duplicates
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64Full = e.target.result; // data:type;base64,xxxx
      const base64Data = base64Full.split(',')[1];
      const isImage = file.type.startsWith('image/');
      attachments.push({
        name: file.name,
        size: file.size,
        base64: base64Data,
        type: file.type || 'application/octet-stream',
        previewUrl: isImage ? base64Full : null
      });
      renderAttachments();
    };
    reader.readAsDataURL(file);
  }
}

function removeAttachment(idx) {
  attachments.splice(idx, 1);
  renderAttachments();
}

function renderAttachments() {
  const el = document.getElementById('attachmentList');
  if (!attachments.length) { el.innerHTML = ''; return; }
  const totalSize = attachments.reduce((s, a) => s + a.size, 0);
  el.innerHTML = attachments.map((a, i) => {
    const preview = a.previewUrl ? '<img class="att-preview" src="' + a.previewUrl + '">' : '<span style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--surface3);border-radius:3px;font-size:12px;flex-shrink:0">ðŸ“Ž</span>';
    return '<div class="att-item">' + preview + '<span class="att-name">' + esc(a.name) + '</span><span class="att-size">' + formatSize(a.size) + '</span><button class="att-remove" data-idx="' + i + '">âœ•</button></div>';
  }).join('') + '<div style="font-size:10px;color:var(--t4);margin-top:4px">' + attachments.length + ' file' + (attachments.length !== 1 ? 's' : '') + ' Â· ' + formatSize(totalSize) + ' total</div>';
  // Bind remove buttons
  el.querySelectorAll('.att-remove').forEach(btn => {
    btn.addEventListener('click', function() { removeAttachment(parseInt(this.dataset.idx)); });
  });
}

function initDropZone() {
  const zone = document.getElementById('dropZone');
  const input = document.getElementById('fileInput');
  const browse = document.getElementById('fileBrowse');

  browse.addEventListener('click', (e) => { e.stopPropagation(); input.click(); });
  zone.addEventListener('click', () => input.click());
  input.addEventListener('change', () => { if (input.files.length) addFiles(input.files); input.value = ''; });

  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    if (e.dataTransfer.files.length) addFiles(e.dataTransfer.files);
  });
}

async function sendBroadcast() {
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();
  const senderAddress = document.getElementById('emailFrom').value;
  const resultEl = document.getElementById('emailResult');
  const btn = document.getElementById('emailSendBtn');

  if (!subject) { resultEl.style.color = 'var(--red)'; resultEl.textContent = 'Subject is required'; return; }
  if (!body) { resultEl.style.color = 'var(--red)'; resultEl.textContent = 'Body is required'; return; }

  const recipients = emailMode === 'all' ? allSubEmails.map(s => s.email) : [...selectedEmails];
  if (!recipients.length) { resultEl.style.color = 'var(--red)'; resultEl.textContent = 'No recipients selected'; return; }

  // Build confirm message
  const attMsg = attachments.length ? ' with ' + attachments.length + ' attachment' + (attachments.length !== 1 ? 's' : '') : '';
  if (!confirm('Send "' + subject + '"' + attMsg + ' to ' + recipients.length + ' recipient' + (recipients.length !== 1 ? 's' : '') + ' from ' + senderAddress + '?')) return;

  btn.disabled = true;
  btn.className = 'email-send-btn sending';
  btn.textContent = 'Sending...';
  resultEl.style.color = 'var(--t3)';
  resultEl.textContent = 'Sending to ' + recipients.length + ' recipients...';

  // Prepare attachments payload
  const attPayload = attachments.map(a => ({ name: a.name, base64: a.base64, type: a.type }));

  try {
    const res = await fetch(API + '/api/admin/send-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Admin-Token': token },
      body: JSON.stringify({ subject, body, senderAddress, recipients, attachments: attPayload })
    });
    const data = await res.json();
    if (data.success) {
      resultEl.style.color = 'var(--green)';
      resultEl.textContent = data.sent + ' sent' + (data.failed ? ', ' + data.failed + ' failed' : '') + ' â€” done!';
      $('emailStatus', data.sent + ' sent');
      // Clear form
      document.getElementById('emailSubject').value = '';
      document.getElementById('emailBody').value = '';
      attachments = [];
      renderAttachments();
    } else {
      resultEl.style.color = 'var(--red)';
      resultEl.textContent = data.error || 'Send failed';
    }
  } catch (err) {
    resultEl.style.color = 'var(--red)';
    resultEl.textContent = 'Network error: ' + err.message;
  } finally {
    btn.disabled = false;
    btn.className = 'email-send-btn';
    btn.textContent = 'Send Broadcast';
  }
}

// â”€â”€ Bind â”€â”€
document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('loginPass').addEventListener('keydown', e=>{if(e.key==='Enter')login();});
document.getElementById('loginUser').addEventListener('keydown', e=>{if(e.key==='Enter')document.getElementById('loginPass').focus();});
document.getElementById('selAll').addEventListener('click', ()=>setEmailMode('all'));
document.getElementById('selCustom').addEventListener('click', ()=>{setEmailMode('custom');buildRecipientList();});
document.getElementById('selNone').addEventListener('click', ()=>{selectedEmails.clear();buildRecipientList();updateRecipientCount();});
document.getElementById('recipientSearch').addEventListener('input', e=>buildRecipientList(e.target.value));
document.getElementById('emailSendBtn').addEventListener('click', sendBroadcast);
initDropZone();

// â”€â”€ Live Predictions â”€â”€
let predInterval;
function scoreColor(sc){return sc>=85?'var(--green)':sc>=70?'var(--blue)':sc>=55?'var(--amber)':sc>=40?'var(--accent)':'var(--red)';}
function scoreBg(sc){return sc>=85?'var(--green-bg)':sc>=70?'var(--blue-bg)':sc>=55?'var(--amber-bg)':sc>=40?'rgba(249,115,22,0.1)':'var(--red-bg)';}
function recBg(r){return r==='GO'?'var(--green-bg)':r==='MAYBE'?'var(--amber-bg)':r==='SKIP'?'var(--blue-bg)':'var(--red-bg)';}
function recCol(r){return r==='GO'?'var(--green)':r==='MAYBE'?'var(--amber)':r==='SKIP'?'var(--blue)':'var(--red)';}
function pctBar(score,max,color){const pct=max>0?Math.round(score/max*100):0;return '<div class="pred-bar-track"><div class="pred-bar-fill" style="width:'+pct+'%;background:'+color+'"></div></div>';}
function fmtTime(iso){if(!iso)return 'â€”';try{return new Date(iso).toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour:'2-digit',minute:'2-digit',hour12:true});}catch(e){return 'â€”';}}
function tagColor(label){const good=['Optimal','Excellent','Very Good','Crystal Clear','Very Clean','Clean','Exceptional','Calm','High Canvas','Stable','Light'];const ok=['Good','Decent','Fair','Hazy','Mid Canvas','Moderate','Slight Fall','Rising','Mixed Layers','Normal'];if(good.includes(label))return 'background:var(--green-bg);color:var(--green)';if(ok.includes(label))return 'background:var(--amber-bg);color:var(--amber)';return 'background:var(--red-bg);color:var(--red)';}

function renderPredCard(k, p, beaches) {
  if(!p||!p.available) return '<div class="pred-card"><div class="pred-beach">'+(beaches[k]||k)+'</div><div class="empty-state" style="padding:40px 0">Unavailable</div></div>';
  const sc=p.score, col=scoreColor(sc), bg=scoreBg(sc);
  const f=p.forecast||{}, b=p.breakdown||{}, labels=p.atmosphericLabels||{}, fac=p.factors||{};
  const rec=p.recommendation||'';
  const sun=p.sunTimes||{}, gh=p.goldenHour||{};
  const ds=p.dataSources||{};
  const ins=p.insights||{};

  // Scoring breakdown rows
  const rows=[
    {name:'Cloud Cover'+(b.cloudCover?.lowStratusDiscount?' <span style="color:var(--amber);font-size:10px">âš  stratus âˆ’'+b.cloudCover.lowStratusDiscount+'</span>':''),val:(b.cloudCover?.value??'?')+'%',score:b.cloudCover?.score??0,max:b.cloudCover?.maxScore??18,label:fac.cloudCover||labels.cloudLabel||''},
    {name:'Multi-Level Cloud',val:(b.multiLevelCloud?.high??'?')+'h / '+(b.multiLevelCloud?.mid??'?')+'m / '+(b.multiLevelCloud?.low??'?')+'l',score:b.multiLevelCloud?.score??0,max:b.multiLevelCloud?.maxScore??20,label:fac.cloudLayers||labels.cloudLayerLabel||''},
    {name:'Humidity',val:(b.humidity?.value??'?')+'%',score:b.humidity?.score??0,max:b.humidity?.maxScore??15,label:fac.humidity||labels.humidityLabel||''},
    {name:'Pressure Trend',val:(b.pressureTrend?.value!=null?b.pressureTrend.value.toFixed(1)+' hPa':'?')+' ('+(b.pressureTrend?.pressureMsl!=null?Math.round(b.pressureTrend.pressureMsl):'')+' msl)',score:b.pressureTrend?.score??0,max:b.pressureTrend?.maxScore??11,label:fac.pressureTrend||labels.pressureLabel||''},
    {name:'AOD (550nm)',val:b.aod?.value!=null?b.aod.value.toFixed(3):'N/A',score:b.aod?.score??0,max:b.aod?.maxScore??16,label:fac.aod||labels.aodLabel||''},
    {name:'Visibility',val:(b.visibility?.value??'?')+' km',score:b.visibility?.score??0,max:b.visibility?.maxScore??5,label:fac.visibility||labels.visibilityLabel||''},
    {name:'Weather',val:(b.weather?.value??'?')+'% precip',score:b.weather?.score??0,max:b.weather?.maxScore??5,label:''},
    {name:'Wind',val:(b.wind?.value??'?')+' km/h',score:b.wind?.score??0,max:b.wind?.maxScore??5,label:fac.wind||labels.windLabel||''}
  ];
  const scoreRows=rows.map(r=>{
    const barCol=r.max>0&&(r.score/r.max)>=0.7?'var(--green)':(r.score/r.max)>=0.4?'var(--amber)':'var(--red)';
    return '<tr><td>'+r.name+(r.label?'<span class="tag" style="'+tagColor(r.label)+'">'+r.label+'</span>':'')+'</td><td>'+r.val+' <span style="color:var(--t4)">'+r.score+'/'+r.max+'</span></td><td>'+pctBar(r.score,r.max,barCol)+'</td></tr>';
  }).join('');

  // Bonuses
  const bonuses=[];
  if(b.synergy!=null&&b.synergy!==0) bonuses.push('Synergy: '+(b.synergy>0?'+':'')+b.synergy+'/Â±4');
  if(b.postRainBonus>0) bonuses.push('Post-rain: +'+b.postRainBonus);
  if(b.solarBonus!=null&&b.solarBonus!==0) bonuses.push('Solar angle: '+(b.solarBonus>0?'+':'')+b.solarBonus+'/Â±2');
  const bonusHTML=bonuses.length?'<div style="margin-top:6px;font-size:11px;color:var(--t3)">'+bonuses.join(' Â· ')+'</div>':'';

  // Cloud layers visual
  const clHTML='<div class="cloud-layers">'+
    '<div class="cloud-layer"><div class="cl-pct" style="color:'+(b.multiLevelCloud?.high>=30?'var(--blue)':'var(--t3)')+'">'+(b.multiLevelCloud?.high??'â€”')+'%</div><div class="cl-name">High</div></div>'+
    '<div class="cloud-layer"><div class="cl-pct" style="color:'+(b.multiLevelCloud?.mid>=40?'var(--amber)':'var(--t3)')+'">'+(b.multiLevelCloud?.mid??'â€”')+'%</div><div class="cl-name">Mid</div></div>'+
    '<div class="cloud-layer"><div class="cl-pct" style="color:'+(b.multiLevelCloud?.low>=50?'var(--red)':'var(--t3)')+'">'+(b.multiLevelCloud?.low??'â€”')+'%</div><div class="cl-name">Low</div></div>'+
  '</div>';

  // Sun times
  const sunHTML='<div class="sun-row">'+
    '<span>Sunrise <span class="sun-val">'+fmtTime(sun.sunRise)+'</span></span>'+
    '<span>Sunset <span class="sun-val">'+fmtTime(sun.sunSet)+'</span></span>'+
    (gh.start?'<span>Golden <span class="sun-val">'+fmtTime(gh.start)+' â€“ '+fmtTime(gh.end)+'</span></span>':'')+
    (sun.moonPhase?'<span>Moon <span class="sun-val">'+esc(sun.moonPhase)+'</span></span>':'')+
  '</div>';

  // Weather conditions
  const condHTML='<div class="pred-conds">'+
    '<div class="pred-cond-item"><span class="lbl">Temperature</span><span class="val">'+(f.temperature??'?')+'Â°C</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Cloud Cover</span><span class="val">'+(f.cloudCover??'?')+'%</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Humidity</span><span class="val">'+(f.humidity??'?')+'%</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Visibility</span><span class="val">'+(f.visibility??'?')+' km</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Wind</span><span class="val">'+(f.windSpeed??'?')+' km/h '+(f.windDirection||'')+'</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Precip Prob</span><span class="val">'+(f.precipProbability??'?')+'%</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">UV Index</span><span class="val">'+(f.uvIndex??'?')+'</span></div>'+
    '<div class="pred-cond-item"><span class="lbl">Description</span><span class="val">'+esc(f.weatherDescription||'â€”')+'</span></div>'+
  '</div>';

  // AI insights (full â€” includes beachVibes + source tag)
  const srcTag=ins.source?'<span class="pred-ai-src '+(ins.source==='rules'?'src-rules':'src-ai')+'">'+esc(ins.source)+'</span>':'';
  const insightHTML=(ins.insight?'<div class="pred-insight">'+esc(ins.insight)+'</div>':'')+
    (ins.whatYoullSee?'<div class="pred-insight" style="margin-top:4px"><strong style="color:var(--t1)">What you\'ll see:</strong> '+esc(ins.whatYoullSee)+'</div>':'')+
    (ins.beachVibes?'<div class="pred-insight" style="margin-top:4px"><strong style="color:var(--t1)">Beach vibes:</strong> '+esc(ins.beachVibes)+'</div>':'')+
    (ins.worthWakingUp?'<div class="pred-insight-worth">'+esc(ins.worthWakingUp)+'</div>':'');

  // Data sources
  const srcHTML='<div class="pred-sources">'+Object.entries(ds).map(([k,v])=>'<span class="pred-src">'+k+': '+v+'</span>').join('')+'</div>';

  return '<div class="pred-card" style="border-top:3px solid '+col+'">'+
    '<div class="pred-header">'+
      '<div><div class="pred-beach">'+esc(p.beach||beaches[k]||k)+'</div>'+
        '<div class="pred-beach-sub">'+(f.forecastTime||'â€”')+'</div>'+
      '</div>'+
      '<div class="pred-score-block">'+
        '<div class="pred-score" style="color:'+col+'">'+sc+'</div>'+
        '<div class="pred-verdict" style="color:'+col+'">'+(p.verdict||'')+'</div>'+
      '</div>'+
    '</div>'+

    '<div class="pred-section">Scoring Breakdown</div>'+
    '<table class="pred-scores">'+scoreRows+'</table>'+
    bonusHTML+

    '<div class="pred-section">Cloud Layers</div>'+
    clHTML+

    '<div class="pred-section">Weather Conditions</div>'+
    condHTML+

    '<div class="pred-section">Sun & Golden Hour</div>'+
    sunHTML+

    '<div class="pred-section">AI Analysis '+srcTag+'</div>'+
    (ins.greeting?'<div style="font-size:11px;color:var(--t1);font-weight:500;margin-bottom:4px">'+esc(ins.greeting)+'</div>':'')+
    insightHTML+

    '<div class="pred-section">Data Sources</div>'+
    srcHTML+
  '</div>';
}

async function fetchPredictions(){
  const grid=document.getElementById('predGrid');
  grid.innerHTML='<div class="empty-state" style="grid-column:1/-1">Loading predictions...</div>';
  try{
    const res=await fetch(API+'/api/admin/predictions',{headers:{'X-Admin-Token':token}});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const d=await res.json();
    if(!d.success||!d.predictions){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1">No predictions available</div>';return;}
    const beaches={marina:'Marina Beach',covelong:'Covelong Beach'};
    const order=['marina','covelong'];
    grid.innerHTML=order.map(k=>renderPredCard(k,d.predictions[k],beaches)).join('');
    const ft=new Date(d.fetchedAt);
    $('predFetchTime','Fetched '+ft.toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false})+' IST');
  }catch(e){
    grid.innerHTML='<div class="empty-state" style="color:var(--red);grid-column:1/-1">Error: '+esc(e.message)+'</div>';
  }
}
document.getElementById('predRefreshBtn').addEventListener('click',fetchPredictions);
// Auto-refresh predictions every 5 minutes once logged in
function startPredAutoRefresh(){
  if(predInterval)clearInterval(predInterval);
  fetchPredictions();
  predInterval=setInterval(fetchPredictions,5*60*1000);
}

// â”€â”€ Auto-login â”€â”€
if(token){fetch(API+'/api/admin/metrics',{headers:{'X-Admin-Token':token}}).then(r=>{if(r.ok)show();else logout();}).catch(()=>logout());}
</script>
</body>
</html>
